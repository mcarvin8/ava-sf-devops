####################################################
# FullQA Org Jobs
# All deployment jobs for the full QA environment
####################################################

test:predeploy:fullqa:
  image: $CI_REGISTRY_IMAGE:$CI_MERGE_REQUEST_TARGET_BRANCH_NAME
  extends: .validate-metadata
  stage: test
  resource_group: fullqa
  rules:
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == 'develop' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == 'fullqa' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'fullqa'
      when: manual
  allow_failure: false
  variables:
    AUTH_ALIAS: FULLQA
    AUTH_URL: $FULLQA_AUTH_URL
  environment:
    name: validate-fullqa
    url: https://avalara--fullqa.sandbox.my.salesforce.com
  tags: 
    - aws,prd,us-west-2

deploy:fullqa:
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  extends: .deploy-metadata
  stage: deploy
  resource_group: fullqa
  rules:
    - if: $FULLQA_DISABLED
      when: never
    - if: $CI_COMMIT_REF_NAME == 'fullqa' && $CI_PIPELINE_SOURCE == 'push'
      when: always
  allow_failure: false
  variables:
    AUTH_ALIAS: FULLQA
    AUTH_URL: $FULLQA_AUTH_URL
    GT_ANNOTATION_ENVIRONMENT: fqa
  environment:
    name: fullqa
    url: https://avalara--fullqa.sandbox.my.salesforce.com
  tags: 
    - aws,prd,us-west-2

destroy:fullqa:
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  extends: .delete-metadata
  stage: destroy
  resource_group: fullqa
  rules:
    - if: $FULLQA_DISABLED
      when: never
    - if: $CI_COMMIT_REF_NAME == 'fullqa' && $CI_PIPELINE_SOURCE == 'web' && $PACKAGE
      when: always
  allow_failure: false
  variables:
    AUTH_ALIAS: FULLQA
    AUTH_URL: $FULLQA_AUTH_URL
    GT_ANNOTATION_ENVIRONMENT: fqa
  environment:
    name: fullqa
    url: https://avalara--fullqa.sandbox.my.salesforce.com
  tags: 
    - aws,prd,us-west-2

merge:fullqa:
  extends: .auto-merge
  stage: merge
  resource_group: merge-fullqa
  needs: []
  rules:
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == 'develop' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == 'ContPar' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'fullqa'
      when: manual
  allow_failure: false
  environment:
    name: fullqa
    url: https://avalara--fullqa.sandbox.my.salesforce.com
  tags: 
    - aws,prd,us-west-2
