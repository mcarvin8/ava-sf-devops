<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Avalara Apex: Require CMT switch"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.github.io/latest/ruleset_xml_schema.xsd">

  <description>
    Enforce Utility.switchRunAutomation(...) on all major automation.
  </description>

  <!-- execute() without switchRunAutomation -->
  <rule name="RequireCmtSwitch_Execute"
        language="apex"
        message="execute() must guard with Utility.switchRunAutomation(...)."
        class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
        priority="3">
    <properties>
      <property name="xpath"
        value="//*[contains(local-name(),'Method')][@Image='execute'][not(.//*[contains(@Image,'switchRunAutomation')])]"/>
    </properties>
  </rule>

  <!-- run() without switchRunAutomation -->
  <rule name="RequireCmtSwitch_Run"
        language="apex"
        message="run() must guard with Utility.switchRunAutomation(...)."
        class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
        priority="3">
    <properties>
      <property name="xpath"
        value="//*[contains(local-name(),'Method')][@Image='run'][not(.//*[contains(@Image,'switchRunAutomation')])]"/>
    </properties>
  </rule>

  <!-- batch entrypoints without switchRunAutomation -->
  <rule name="RequireCmtSwitch_BatchEntrypoints"
        language="apex"
        message="Batch entry methods (start/execute/finish) must guard with Utility.switchRunAutomation(...)."
        class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
        priority="3">
    <properties>
      <property name="xpath"
        value="//*[contains(local-name(),'Method')][@Image=('start','execute','finish')][not(.//*[contains(@Image,'switchRunAutomation')])]"/>
    </properties>
  </rule>

  <!-- optional: public/protected/global *Automation without switchRunAutomation -->
  <rule name="RequireCmtSwitch_MethodsNamedAutomation"
        language="apex"
        message="Public/protected/global '*Automation' method must guard with Utility.switchRunAutomation(...)."
        class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
        priority="4">
    <properties>
      <property name="xpath"
        value="//MethodDeclaration[ .//Modifiers/Modifier[@Image=('public','protected','global')] ][ ends-with(@Image,'Automation') ][ not(.//*[contains(@Image,'switchRunAutomation')]) ]"/>
    </properties>
  </rule>

</ruleset>
